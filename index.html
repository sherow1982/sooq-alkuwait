<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سوق الكويت | Souq Al-Kuwait</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = {theme: {extend: {colors: {primary: '#1e3a8a', secondary: '#fbbf24', surface: '#f8fafc'}, fontFamily: {tajawal: ['Tajawal', 'sans-serif']}}}}</script>
    <style>.hide-scrollbar::-webkit-scrollbar { display: none; }</style>
</head>
<body class="bg-surface font-tajawal text-gray-800 flex flex-col min-h-screen">

    <main class="container mx-auto px-4 py-8 flex-grow">
        
        <!-- البنر العلوي -->
        <div class="mb-8">
            <img src="https://raw.githubusercontent.com/sherow1982/sooq-alkuwait/main/%D8%B3%D9%88%D9%82%20%D8%A7%D9%84%D9%83%D9%88%D9%8A%D8%AA.webp" 
                 alt="سوق الكويت" 
                 class="w-full h-auto rounded-3xl shadow-lg object-cover hover:shadow-xl transition-shadow duration-300">
        </div>

        <!-- Hero Section -->
        <header class="bg-primary text-white py-12 relative overflow-hidden rounded-[2rem] shadow-xl text-center mb-10">
            <div class="relative z-10">
                <h1 class="text-3xl md:text-5xl font-bold mb-6">أفضل العروض في الكويت</h1>
                <p class="text-blue-200 mb-8 max-w-lg mx-auto">تسوق بثقة مع ضمان 14 يوم للاسترجاع وتوصيل سريع لباب بيتك.</p>
                <div class="max-w-xl mx-auto relative group px-4">
                    <input type="text" id="search-input" placeholder="ابحث عن منتج..." class="w-full py-4 px-6 rounded-full text-gray-800 shadow-xl focus:outline-none focus:ring-4 focus:ring-secondary/50 transition">
                    <i class="fa-solid fa-search absolute left-8 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
        </header>

        <!-- Categories -->
        <div class="mb-8">
            <h2 class="font-bold text-gray-700 mb-3 px-1">تصفح الأقسام</h2>
            <div class="flex gap-3 overflow-x-auto hide-scrollbar pb-2" id="category-filters"></div>
        </div>

        <!-- Products Grid -->
        <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 md:gap-6">
            <div class="col-span-full text-center py-20"><i class="fa-solid fa-circle-notch fa-spin text-primary text-2xl"></i></div>
        </div>
        
        <!-- Load More -->
        <div class="text-center mt-12 hidden" id="load-more-container">
            <button onclick="loadMoreProducts()" class="bg-white border-2 border-gray-200 text-gray-700 hover:border-primary hover:text-primary font-bold py-3 px-8 rounded-full shadow-sm transition-all transform hover:scale-105">
                عرض المزيد <i class="fa-solid fa-chevron-down mr-2"></i>
            </button>
        </div>
    </main>

    <!-- Scripts -->
    <script src="layout.js"></script>
    <script src="script.js"></script>
    <script>
        // Pagination & Rendering Logic
        let currentDisplayCount = 12;
        let currentFilteredProducts = [];
        const originalRenderProducts = window.renderProducts;

        window.renderProducts = function(products) {
            currentFilteredProducts = products;
            const grid = document.getElementById('products-grid');
            const loadMoreBtn = document.getElementById('load-more-container');
            
            if (!products || products.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10">لا توجد منتجات.</p>';
                loadMoreBtn.classList.add('hidden');
                return;
            }

            const toShow = products.slice(0, currentDisplayCount);
            
            grid.innerHTML = toShow.map(product => {
                // ----------------------------------------------------
                // معالجة الأسعار بناءً على JSON الخاص بك
                // "pricing": { "regular": "23", "sale": "16" }
                // ----------------------------------------------------
                
                // 1. قراءة القيم (قد تكون نصاً أو رقماً)
                const regularVal = product.pricing?.regular;
                const saleVal = product.pricing?.sale;

                // 2. تحويلها لأرقام (يضمن عدم حدوث خطأ NaN)
                // parseFloat يتعامل مع "23" ويحولها لـ 23.0
                const regularPrice = parseFloat(regularVal) || 0;
                const salePrice = parseFloat(saleVal) || 0;

                // 3. التحقق من وجود خصم
                // الخصم موجود فقط إذا كان سعر البيع أكبر من 0 وأقل من السعر العادي
                const hasDiscount = (salePrice > 0 && salePrice < regularPrice);
                
                // 4. تحديد السعر النهائي للعرض (كرقم)
                const finalPrice = hasDiscount ? salePrice : regularPrice;

                // 5. تجهيز النصوص للعرض (مع toFixed)
                const displayPriceStr = finalPrice.toFixed(2);
                const oldPriceStr = regularPrice.toFixed(2);

                // تجهيز الصورة والعنوان
                const image = product.media?.main_image || "https://via.placeholder.com/300";
                const title = product.title || "بدون عنوان";
                const category = product.category || "عام";

                return `
                <div class="bg-white rounded-2xl overflow-hidden group border border-gray-100 hover:shadow-xl transition-all duration-300 flex flex-col h-full">
                    <div class="relative aspect-square overflow-hidden bg-gray-50">
                        <a href="product.html?id=${product.id}" class="block w-full h-full">
                            <img src="${image}" alt="${title}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy">
                        </a>
                        ${hasDiscount ? `<span class="absolute top-3 right-3 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded shadow-sm z-10">خصم</span>` : ''}
                        <button onclick="addToCartFromHome('${product.id}')" class="absolute bottom-3 right-3 w-10 h-10 bg-white text-primary rounded-full shadow-lg flex items-center justify-center transform translate-y-14 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300 z-20 hover:bg-primary hover:text-white"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                        <div class="text-xs text-gray-500 mb-1 font-medium bg-gray-50 w-fit px-2 py-0.5 rounded">${category}</div>
                        <a href="product.html?id=${product.id}" class="block group-hover:text-primary transition-colors">
                            <h3 class="font-bold text-gray-800 mb-2 line-clamp-2 text-sm leading-relaxed min-h-[2.5rem]">${title}</h3>
                        </a>
                        <div class="mt-auto pt-3 border-t border-gray-50 flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="text-lg font-extrabold text-primary">${displayPriceStr} KWD</span>
                                ${hasDiscount ? `<span class="text-xs text-gray-400 line-through">${oldPriceStr}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            if (currentDisplayCount >= products.length) loadMoreBtn.classList.add('hidden');
            else loadMoreBtn.classList.remove('hidden');
        };

        function loadMoreProducts() { 
            currentDisplayCount += 12; 
            window.renderProducts(currentFilteredProducts); 
        }
    </script>
</body>
</html>
